<!DOCTYPE html>
<html lang="ko">
    {% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveCaption - ë™ì˜ìƒ ìë§‰ ìƒì„± ì„œë¹„ìŠ¤</title>
    
    <!-- Custom static CSS file -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <!-- í—¤ë” ì„¹ì…˜ -->
    <header>
        <div class="container">
            <h1 class="title">LiveCaption</h1>
            <p class="subtitle">ë™ì˜ìƒ ìë§‰ ìë™ ìƒì„± ì„œë¹„ìŠ¤</p>
        </div>
    </header>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="container">
        <div class="main-content">
            <!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
            <section class="upload-section">
                <h2 class="upload-title">ë™ì˜ìƒ ì—…ë¡œë“œ</h2>
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">ğŸ“</div>
                    <p class="upload-text">ë™ì˜ìƒ íŒŒì¼ì„ ì—¬ê¸°ì— ëŒì–´ë‹¤ ë†“ê±°ë‚˜</p>
                    <button class="upload-btn" id="select-file-btn">íŒŒì¼ ì„ íƒ</button>
                    <input type="file" id="file-input" class="file-input" accept="video/*">
                    <p class="upload-info">ì§€ì› í˜•ì‹: MP4, AVI, MOV, WMV | ìµœëŒ€ í¬ê¸°: 500MB</p>
                </div>
            </section>

            <!-- ë¹„ë””ì˜¤ ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ -->
            <section class="preview-section" id="preview-section">
                <h2 class="preview-title">ë™ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°</h2>
                <div class="video-container">
                    <video class="video-preview" id="video-preview" controls></video>
                </div>

                <!-- ìë§‰ ì„¤ì • ì˜µì…˜ -->
                <div class="caption-settings" id="caption-settings">
                    <h3 class="settings-title">ìë§‰ ì„¤ì •</h3>
                    
                    <!-- í°íŠ¸ í¬ê¸° ì„¤ì • -->
                    <div class="settings-group">
                        <h4>ìë§‰ í°íŠ¸ í¬ê¸° ì„¤ì •</h4>
                        <div class="font-settings">
                            <div class="setting-item">
                                <label for="default-font-size">ê¸°ë³¸ í°íŠ¸ í¬ê¸° (px)</label>
                                <input type="number" id="default-font-size" min="10" max="72" value="24">
                            </div>
                            <div class="setting-item">
                                <label for="min-font-size">ìµœì†Œ í°íŠ¸ í¬ê¸° (px)</label>
                                <input type="number" id="min-font-size" min="8" max="36" value="16">
                            </div>
                            <div class="setting-item">
                                <label for="max-font-size">ìµœëŒ€ í°íŠ¸ í¬ê¸° (px)</label>
                                <input type="number" id="max-font-size" min="16" max="96" value="36">
                            </div>
                        </div>
                    </div>
                    
                    <!-- ìƒ‰ìƒ ì„¤ì • -->
                    <div class="settings-group">
                        <h4>ìë§‰ ìƒ‰ìƒ ì„¤ì •</h4>
                        <div class="color-settings">
                            <div class="setting-item">
                                <label for="highlight-color">í•˜ì´ë¼ì´íŠ¸ ìƒ‰ìƒ</label>
                                <input type="color" id="highlight-color" value="#FFFF00">
                            </div>
                        </div>
                    </div>
                    
                    <!-- ê°ì •ë³„ ìƒ‰ìƒ ì„¤ì • -->
                    <div class="settings-group">
                        <h4>ê°ì •ë³„ ìë§‰ ìƒ‰ìƒ ì„¤ì •</h4>
                        <div class="emotion-colors-container">
                            <div class="emotion-colors-grid" id="emotion-colors-grid">
                                <!-- ê°ì • ìƒ‰ìƒ ì„¤ì •ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                            </div>
                            <div class="emotion-actions">
                                <button class="emotion-btn reset-emotions-btn" id="reset-emotions-btn">ê¸°ë³¸ê°’ ë³µì›</button>
                                <!-- í–¥í›„ ê°ì • ì¶”ê°€ ê¸°ëŠ¥ì„ ìœ„í•œ ë²„íŠ¼ (í˜„ì¬ëŠ” ìˆ¨ê¹€) -->
                                <!-- <button class="emotion-btn add-emotion-btn" id="add-emotion-btn">ê°ì • ì¶”ê°€</button> -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="preview-controls">
                    <button class="generate-btn" id="generate-btn">ìë§‰ ìƒì„±í•˜ê¸°</button>
                    <button class="cancel-btn" id="cancel-btn">ì·¨ì†Œ</button>
                </div>
            </section>

            <!-- ìë§‰ ì„¹ì…˜ -->
            <section class="caption-section" id="caption-section">
                <h2 class="caption-title">ìƒì„±ëœ ìë§‰</h2>
                
                <!-- ë¡œë”© í‘œì‹œ -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>ìë§‰ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
                </div>
                
                <!-- ìë§‰ ë‚´ìš© -->
                <div class="caption-content" id="caption-content">
                    <textarea class="caption-textarea" id="caption-textarea" placeholder="ìë§‰ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                    <div class="caption-controls">
                        <button class="download-btn" id="download-btn">ìë§‰ ë‹¤ìš´ë¡œë“œ</button>
                        <div>
                            <label for="format-select">í˜•ì‹:</label>
                            <select class="format-select" id="format-select">
                                <option value="srt">SRT</option>
                                <option value="vtt">VTT</option>
                                <option value="txt">TXT</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- í‘¸í„° -->
    <footer>
        <div class="container">
            <p>&copy; 2025 LiveCaption.</p>
        </div>
    </footer>

    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        import { FFmpeg } from '../static/@ffmpeg/ffmpeg/dist/esm/index.js'
        import { fetchFile } from '../static/@ffmpeg/util/dist/esm/index.js'

        // ê°ì • ë°ì´í„° ì •ì˜
        const EMOTIONS = {
            neutral: { name: 'ì¤‘ë¦½', defaultColor: '#FFFFFF' },
            happy: { name: 'í–‰ë³µ', defaultColor: '#00FF00' },
            sad: { name: 'ìŠ¬í””', defaultColor: '#FF0000' },
            angry: { name: 'ë¶„ë…¸', defaultColor: '#0000FF' },
            fear: { name: 'ê³µí¬', defaultColor: '#800080' },
            surprise: { name: 'ë†€ëŒ', defaultColor: '#00FFFF' },
            disgust: { name: 'í˜ì˜¤', defaultColor: '#008080' }
            // newEmotion: { name: 'ê°ì •', defaultColor: '#ìƒ‰ìƒì½”ë“œ' }
        };

        // DOM ìš”ì†Œ ì„ íƒ
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const selectFileBtn = document.getElementById('select-file-btn');
        const previewSection = document.getElementById('preview-section');
        const videoPreview = document.getElementById('video-preview');
        const generateBtn = document.getElementById('generate-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const captionSection = document.getElementById('caption-section');
        const loading = document.getElementById('loading');
        const captionContent = document.getElementById('caption-content');
        const captionTextarea = document.getElementById('caption-textarea');
        const downloadBtn = document.getElementById('download-btn');
        const formatSelect = document.getElementById('format-select');

        // ìë§‰ ì„¤ì • ìš”ì†Œ
        const defaultFontSize = document.getElementById('default-font-size');
        const minFontSize = document.getElementById('min-font-size');
        const maxFontSize = document.getElementById('max-font-size');
        const highlightColor = document.getElementById('highlight-color');
        const emotionColorsGrid = document.getElementById('emotion-colors-grid');
        const resetEmotionsBtn = document.getElementById('reset-emotions-btn');
        
        const ffmpeg = new FFmpeg();
        await ffmpeg.load();

        let audioBlob = null;

        async function extractAudio(videoFile) {
            await ffmpeg.writeFile('input.mp4', await fetchFile(videoFile));
            await ffmpeg.exec(['-i', 'input.mp4', '-vn', 'output.wav']);
            const audioData = await ffmpeg.readFile('output.wav');
            audioBlob = new Blob([audioData.buffer], { type: 'audio/wav' });
        }

        async function generateCaptions() {
            const videoFile = fileInput.files[0];
            if (!videoFile) {
                alert('ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            try {
                await extractAudio(videoFile);
            } catch (err) {
                console.error('ì˜¤ë””ì˜¤ ì¶”ì¶œ ì‹¤íŒ¨:', err);
                alert('ì˜¤ë””ì˜¤ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                return;
            }

            const formData = new FormData();
            formData.append('audio', audioBlob, 'audio.wav');

            try {
                const res = await fetch('/STT/generate-caption/', {
                    method: 'POST',
                    body: formData,
                });
                if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');

                const captions = await res.text();
                captionTextarea.value = captions;
                loading.style.display = 'none';
                captionContent.style.display = 'block';
            } catch (err) {
                console.error('ìë§‰ ìƒì„± ì˜¤ë¥˜:', err);
                alert('ìë§‰ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê°ì • ìƒ‰ìƒ ì„¤ì • UI ìƒì„± í•¨ìˆ˜
        function createEmotionColorSettings() {
            emotionColorsGrid.innerHTML = '';
            
            Object.entries(EMOTIONS).forEach(([emotionKey, emotionData]) => {
                const emotionItem = document.createElement('div');
                emotionItem.className = 'emotion-item';
                
                emotionItem.innerHTML = `
                    <label class="emotion-label" for="emotion-${emotionKey}">${emotionData.name}</label>
                    <input 
                        type="color" 
                        id="emotion-${emotionKey}" 
                        class="emotion-color-input" 
                        value="${emotionData.defaultColor}"
                        data-emotion="${emotionKey}"
                    >
                `;
                
                emotionColorsGrid.appendChild(emotionItem);
            });
        }

        // ê°ì • ìƒ‰ìƒ ì„¤ì • ê°’ ìˆ˜ì§‘ í•¨ìˆ˜
        function getEmotionColors() {
            const emotionColors = {};
            
            Object.keys(EMOTIONS).forEach(emotionKey => {
                const colorInput = document.getElementById(`emotion-${emotionKey}`);
                if (colorInput) {
                    emotionColors[emotionKey] = colorInput.value;
                }
            });
            
            return emotionColors;
        }

        // ê°ì • ìƒ‰ìƒì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹í•˜ëŠ” í•¨ìˆ˜
        function resetEmotionColors() {
            Object.entries(EMOTIONS).forEach(([emotionKey, emotionData]) => {
                const colorInput = document.getElementById(`emotion-${emotionKey}`);
                if (colorInput) {
                    colorInput.value = emotionData.defaultColor;
                }
            });
        }

        //ê°ì • ìƒ‰ìƒ ì„¤ì • UI ìƒì„±
        createEmotionColorSettings();

        // ê¸°ë³¸ê°’ ë³µì› ë²„íŠ¼ ì´ë²¤íŠ¸
        resetEmotionsBtn.addEventListener('click', () => {
            if (confirm('ëª¨ë“  ê°ì • ìƒ‰ìƒì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                resetEmotionColors();
            }
        });

        // í°íŠ¸ í¬ê¸° ìœ íš¨ì„± ê²€ì‚¬
        function validateFontSizes() {
            const defaultSize = parseInt(defaultFontSize.value);
            const minSize = parseInt(minFontSize.value);
            const maxSize = parseInt(maxFontSize.value);
            
            if (minSize > defaultSize) {
                alert('ìµœì†Œ í°íŠ¸ í¬ê¸°ëŠ” ê¸°ë³¸ í°íŠ¸ í¬ê¸°ë³´ë‹¤ ì‘ì•„ì•¼ í•©ë‹ˆë‹¤.');
                minFontSize.value = defaultSize - 4;
                return false;
            }
            
            if (maxSize < defaultSize) {
                alert('ìµœëŒ€ í°íŠ¸ í¬ê¸°ëŠ” ê¸°ë³¸ í°íŠ¸ í¬ê¸°ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.');
                maxFontSize.value = defaultSize + 4;
                return false;
            }
            
            return true;
        }

        // í°íŠ¸ í¬ê¸° ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ìœ íš¨ì„± ê²€ì‚¬
        defaultFontSize.addEventListener('change', validateFontSizes);
        minFontSize.addEventListener('change', validateFontSizes);
        maxFontSize.addEventListener('change', validateFontSizes);

        // ìë§‰ ìƒì„± ë²„íŠ¼ í´ë¦­ ì‹œ
        generateBtn.addEventListener('click', async () => {
            captionSection.style.display = 'block';
            loading.style.display = 'block';
            captionContent.style.display = 'none';
            captionSection.scrollIntoView({ behavior: 'smooth' });

            await generateCaptions();
        });

        // íŒŒì¼ ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ íŒŒì¼ ì…ë ¥ ì°½ ì—´ê¸°
        selectFileBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // íŒŒì¼ ì…ë ¥ ë³€ê²½ ì‹œ ì²˜ë¦¬
        fileInput.addEventListener('change', handleFileSelect);

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#4a00e0';
            uploadArea.style.backgroundColor = '#f9f9f9';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#ccc';
            uploadArea.style.backgroundColor = 'transparent';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ccc';
            uploadArea.style.backgroundColor = 'transparent';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // íŒŒì¼ ì„ íƒ ì²˜ë¦¬ í•¨ìˆ˜
        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        // íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
        function handleFile(file) {
            // íŒŒì¼ ìœ í˜• ê²€ì‚¬
            if (!file.type.startsWith('video/')) {
                alert('ë¹„ë””ì˜¤ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            // íŒŒì¼ í¬ê¸° ê²€ì‚¬ (500MB ì œí•œ)
            if (file.size > 500 * 1024 * 1024) {
                alert('íŒŒì¼ í¬ê¸°ëŠ” 500MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë¹„ë””ì˜¤ ë¯¸ë¦¬ë³´ê¸° ì„¤ì •
            const videoURL = URL.createObjectURL(file);
            videoPreview.src = videoURL;
            
            // ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ í‘œì‹œ
            previewSection.style.display = 'block';
            
            // í˜ì´ì§€ ìŠ¤í¬ë¡¤
            previewSection.scrollIntoView({ behavior: 'smooth' });
        }

        // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ
        cancelBtn.addEventListener('click', () => {
            // ë¹„ë””ì˜¤ ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
            videoPreview.src = '';
            
            // ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            previewSection.style.display = 'none';
            captionSection.style.display = 'none';
            
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            fileInput.value = '';
        });

        // ìë§‰ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ
        downloadBtn.addEventListener('click', () => {
            const format = formatSelect.value;
            const content = captionTextarea.value;
            
            if (!content.trim()) {
                alert('ë‹¤ìš´ë¡œë“œí•  ìë§‰ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // íŒŒì¼ ì´ë¦„ ì„¤ì •
            const filename = `captions.${format}`;
            
            // Blob ìƒì„±
            const blob = new Blob([content], { type: 'text/plain' });
            
            // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            
            // ë§í¬ í´ë¦­í•˜ì—¬ ë‹¤ìš´ë¡œë“œ ì‹œì‘
            document.body.appendChild(a);
            a.click();
            
            // ì •ë¦¬
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>